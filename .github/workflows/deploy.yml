# Bu workflow'un adÄ±
name: Deploy AI Vision App to Cloud Run

# Tetikleyici: Sadece "main" dalÄ±na "push" yapÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
on:
  push:
    branches:
      - main

# Ortam deÄŸiÅŸkenleri: TÃ¼m adÄ±mlarda kullanÄ±lacak
env:
  # Sizin Proje ID'niz
  PROJECT_ID: benim-devops-projem-12345
  # Sizin BÃ¶lgeniz
  REGION: europe-west10
  # YENÄ° Artifact Registry depo adÄ±mÄ±z (AÅŸama 3'te oluÅŸturduk)
  REPO_NAME: ai-vision-repo
  # YENÄ° Cloud Run servis adÄ±mÄ±z
  SERVICE_NAME: ai-vision-service

jobs:
  deploy:
    # Bu iÅŸin Ã§alÄ±ÅŸacaÄŸÄ± sanal makine
    runs-on: ubuntu-latest

    # Ä°zinler: GitHub Actions'a WIF iÃ§in OIDC token oluÅŸturma izni verir
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. AdÄ±m: Kodu (GitHub deposunu) sanal makineye indir
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AdÄ±m: Google Cloud'da gÃ¼venli bir ÅŸekilde oturum aÃ§ (WIF)
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          # GitHub Secrets bilgileri (AÅŸama 5'te ekledik)
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      # 3. AdÄ±m: gcloud (Google Cloud CLI) aracÄ±nÄ± kur
      - name: Setup Google Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # 4. AdÄ±m: Docker'Ä± Artifact Registry'ye baÄŸlanmasÄ± iÃ§in ayarla
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 5. AdÄ±m: Dockerfile'dan imajÄ± oluÅŸtur (Build)
      - name: Build Docker Image
        run: |-
          docker build \
            --tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest \
            .

      # 6. AdÄ±m: Docker imajÄ±nÄ± Artifact Registry'ye it (Push)
      - name: Push Docker Image
        run: |-
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest

      # 7. AdÄ±m: Docker imajÄ±nÄ± Cloud Run'a daÄŸÄ±t (Deploy)
      # Bu adÄ±mda Storage ve Vision API'ye otomatik olarak baÄŸlanacak (Ã§Ã¼nkÃ¼ IAM izni verdik)
      - name: Deploy to Cloud Run
        run: |-
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated
```eof

---

### ğŸ—ºï¸ AÅŸama 7: FÄ±rlatma (Son Push)!

TÃ¼m bu adÄ±mlar tamamlandÄ±ÄŸÄ±nda, lokal klasÃ¶rÃ¼nÃ¼ze geri dÃ¶nÃ¼n ve bu son `.github` klasÃ¶rÃ¼nÃ¼ de GitHub'a gÃ¶nderin.

1.  Terminalinizi aÃ§Ä±n (`gcp_AI_projeckt` klasÃ¶rÃ¼nde):

    ```bash
    # 1. Yeni .github klasÃ¶rÃ¼nÃ¼ ve yml dosyasÄ±nÄ± ekle
    git add .
    
    # 2. Commit oluÅŸtur
    git commit -m "CI/CD pipeline eklendi (Yapay Zeka Projesi)"
    
    # 3. GitHub'a gÃ¶nder (push) - Bu, otomasyonu tetikleyecek!
    git push origin main
    ```

---

### ğŸš€ AÅŸama 8: Hata AyÄ±klama (Firestore Ä°ndeksi)

`git push` komutu biter bitmez, GitHub deponuzdaki **"Actions"** sekmesine gidin ve otomasyonun Ã§alÄ±ÅŸmasÄ±nÄ± izleyin.

**Ã‡OK Ã–NEMLÄ°:** Otomasyon (GitHub Actions) **yeÅŸil tik (âœ“)** aldÄ±ÄŸÄ±nda, sitenizi aÃ§maya Ã§alÄ±ÅŸÄ±rsanÄ±z **"Internal Server Error" (HTTP 500)** hatasÄ± alacaksÄ±nÄ±z.

**Paniklemeyin!** Bu, "Fikir Panosu" projesinde yaÅŸadÄ±ÄŸÄ±mÄ±z hatanÄ±n aynÄ±sÄ±dÄ±r. `app.py` kodumuz, sonuÃ§larÄ± `timestamp`'e (zaman damgasÄ±) gÃ¶re sÄ±ralamaya (`order_by`) Ã§alÄ±ÅŸÄ±yor ve Firestore bunun iÃ§in Ã¶zel bir "indeks" (kural) oluÅŸturmamÄ±zÄ± istiyor.

**Ã‡Ã¶zÃ¼m:**
1.  Hata aldÄ±ktan sonra, Google Cloud'da **Cloud Run** -> `ai-vision-service` -> **"LOGS" (KAYITLAR)** sekmesine gidin.
2.  Oradaki **kÄ±rmÄ±zÄ± `Traceback...`** hatasÄ±nÄ± bulun.
3.  Hata mesajÄ±nÄ±n iÃ§indeki `FailedPrecondition...` ile baÅŸlayan satÄ±rÄ± ve onun altÄ±ndaki **"Ä°ndeks OluÅŸturma Linki"ni** (`https://console.cloud.google.com/firestore/indexes/composite/create?....`) bulun.
4.  O linke tÄ±klayÄ±n, aÃ§Ä±lan sayfada **"CREATE" (OLUÅTUR)** butonuna basÄ±n.
5.  Ä°ndeksin oluÅŸturulmasÄ± (yaklaÅŸÄ±k 2-5 dakika) bittikten sonra sitenizi (`.run.app` URL'si) yenileyin.

Ä°ÅŸte o zaman projeniz tam olarak Ã§alÄ±ÅŸmaya baÅŸlayacaktÄ±r!